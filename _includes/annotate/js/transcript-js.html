<script type="text/javascript">
  document.getElementById('players').addEventListener('change', function () {
    var myClass = this.value;
    document.querySelectorAll('section').forEach(function(section) {
      section.classList.remove('featured');
    });
    document.querySelectorAll('div').forEach(function(div) {
      div.classList.remove('anchored-highlight');
    });
    document.querySelectorAll('.playline').forEach(function(line) {
      line.style.display = 'none';
    });
    document.querySelectorAll('div.' + myClass).forEach(function(div) {
      div.style.display = ''; // Or 'block' if that's more appropriate
    });
    const quicksearchInput = document.getElementById('quicksearch');
    if (quicksearchInput) {
      quicksearchInput.value = '';
    }
    var numberofint = document.querySelectorAll('div.' + myClass).length;
    const numberOfEl = document.getElementById('numberof');
    if (numberOfEl) {
      numberOfEl.innerHTML = numberofint + ' lines';
    }
    document.querySelectorAll('.linecount').forEach(function(el) {
      el.classList.remove('d-none');
    });

    const firstOptionValue = document.querySelector('select option') ? document.querySelector('select option').value : '';
    document.querySelectorAll('select').forEach(function(select) {
      if (select !== this) {
        select.value = firstOptionValue;
      }
    }.bind(this)); // Bind 'this' to maintain its context from the event listener

    let url = new URL(window.location);
    let params = url.searchParams;
    params.set('player', myClass);
    params.delete('q');
    params.delete('scene');
    var p = params.toString();
    window.history.replaceState({}, '', location.pathname + '?' + p);
  });

  document.getElementById('scenes').addEventListener('change', function () {
    var myClass = this.value;
    document.querySelectorAll('section').forEach(function(section) {
      section.classList.remove('featured');
    });
    document.querySelectorAll('div').forEach(function(div) {
      div.classList.remove('anchored-highlight');
    });
    document.querySelectorAll('.playline').forEach(function(line) {
      line.style.display = 'none';
    });
    document.querySelectorAll('div.' + myClass).forEach(function(div) {
      div.style.display = ''; // Or 'block'
    });
    const quicksearchInput = document.getElementById('quicksearch');
    if (quicksearchInput) {
      quicksearchInput.value = '';
    }
    var numberofint = document.querySelectorAll('div.' + myClass).length;
    const numberOfEl = document.getElementById('numberof');
    if (numberOfEl) {
      numberOfEl.innerHTML = numberofint + ' lines';
    }
    document.querySelectorAll('.linecount').forEach(function(el) {
      el.classList.remove('d-none');
    });

    const firstOptionValue = document.querySelector('select option') ? document.querySelector('select option').value : '';
    document.querySelectorAll('select').forEach(function(select) {
      if (select !== this) {
        select.value = firstOptionValue;
      }
    }.bind(this)); // Bind 'this'

    let url = new URL(window.location);
    let params = url.searchParams;
    params.set('scene', myClass);
    params.delete('q');
    params.delete('player');
    var p = params.toString();
    window.history.replaceState({}, '', location.pathname + '?' + p);
  });

  const filtersButton = document.getElementById('filters');
  if (filtersButton) {
    filtersButton.addEventListener('click', function () {
      let url = new URL(window.location);
      var sceneFilter = url.searchParams.get('scene');
      if (sceneFilter) {
        // No action taken if sceneFilter exists
      } else {
        const sideSceneScroll = document.getElementById('side-scene-scroll');
        if (sideSceneScroll) {
          sideSceneScroll.classList.toggle('d-none');
        }
        const resetButton = document.querySelector('button.reset');
        if (resetButton) {
          resetButton.click();
        }
      }
    });
  }

  document.querySelectorAll('button.reset').forEach(function(button) {
    button.addEventListener('click', function () {
      document.querySelectorAll('.playline').forEach(function(line) {
        line.style.display = ''; // Or 'block'
      });
      document.querySelectorAll('div').forEach(function(div) {
        div.classList.remove('anchored-highlight');
        div.classList.remove('annotate-show');
        div.classList.remove('featured');
      });
      document.querySelectorAll('section').forEach(function(section) {
        section.classList.remove('featured');
      });
      document.querySelectorAll('span').forEach(function(span) {
        span.classList.remove('text-danger');
      });
      const quicksearchInput = document.getElementById('quicksearch');
      if (quicksearchInput) {
        quicksearchInput.value = '';
      }
      const playersSelect = document.getElementById('players');
      if (playersSelect && playersSelect.options.length > 0) {
        playersSelect.value = playersSelect.options[0].value;
      }
      const scenesSelect = document.getElementById('scenes');
      if (scenesSelect && scenesSelect.options.length > 0) {
        scenesSelect.value = scenesSelect.options[0].value;
      }
      var numberofint = document.querySelectorAll('section').length; // Assuming this counts relevant sections
      const numberOfEl = document.getElementById('numberof');
      if (numberOfEl) {
        numberOfEl.innerHTML = numberofint + ' lines';
      }
      let url = new URL(window.location);
      let params = url.searchParams;
      params.delete('q');
      params.delete('player');
      params.delete('scene');
      var p = params.toString();
      window.history.replaceState({}, '', location.pathname + '?' + p);
      document.querySelectorAll('.filter-search').forEach(function(el) {
        el.classList.add('d-none');
      });
      const searchResultsEl = document.getElementById('searchResults');
      if (searchResultsEl) {
        searchResultsEl.innerHTML = '';
      }
    });
  });

  // Note: Clicking an <option> element directly is not standard and may not work reliably.
  // This typically should be handled by the 'change' event on the parent <select>.
  // The original jQuery $("option:first") selects the very first option tag in the document.
  const firstOptionElement = document.querySelector('option');
  if (firstOptionElement) {
    firstOptionElement.addEventListener('click', function () {
      const resetButton = document.querySelector('button.reset');
      if (resetButton) {
        resetButton.click();
      }
    });
  }


 function filterLines() {
    document.querySelectorAll('.playerline').forEach(function(el) {
      el.classList.remove('anchored-highlight');
      el.classList.remove('featured');
    });

    var input = document.getElementById("quicksearch");
    if (!input) return;

    let url = new URL(window.location);
    let params = url.searchParams;
    params.set('q', input.value);
    var p = params.toString();
    window.history.replaceState({}, '', location.pathname + '?' + p);

    var filterplain = input.value;
    var filter = input.value.toUpperCase();
    var itemcontainer = document.getElementById("contents-container");
    if (!itemcontainer) return;

    var items = itemcontainer.getElementsByTagName("section");
    var searchResultsHTML = '<option>Select and scroll to a matching line</option>';
    var featuredCount = 0;

    for (var i = 0; i < items.length; i++) {
      var itemcontents = items[i].getElementsByClassName("playerline")[0];
      if (itemcontents) {
        // Reset previous highlights for this specific item if re-filtering
        // This part is tricky without knowing the original un-highlighted state.
        // For simplicity, we're just adding new highlights.
        // A more robust solution would store original HTML or remove only our specific spans.
        // For now, we'll assume the replace logic is sufficient as per original.

        if (itemcontents.textContent.toUpperCase().indexOf(filter) > -1) { // Search in textContent for accuracy
          itemcontents.classList.add("featured");
          featuredCount++;
          // Highlighting: replace only the first occurrence in the current HTML
          // This might re-wrap existing spans if not careful.
          // A safer way is to work with text nodes or reset innerHTML before highlighting.
          itemcontents.innerHTML = itemcontents.innerHTML.replace(new RegExp(filterplain.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i'), "<span class='text-danger'>$&</span>");
          searchResultsHTML += '<option value="'+ items[i].id +'">'+itemcontents.textContent.substring(0,100) + '...</option>'; // Use item ID for value and textContent
        }
      }
    }
    const numberOfLinesEl = document.getElementById('numberoflines');
    if (numberOfLinesEl) {
      numberOfLinesEl.innerHTML = featuredCount + " lines match your query";
    }
    const searchResultsSelect = document.getElementById('searchResults');
    if (searchResultsSelect) {
      searchResultsSelect.innerHTML = searchResultsHTML;
    }
    document.querySelectorAll('.linecount').forEach(function(el) {
      el.classList.remove('d-none');
    });
    document.querySelectorAll('.filter-search').forEach(function(el) {
      el.classList.remove('d-none');
    });
  }

</script>
<script>
  /* filter items by entering value of button or link pushed into quicksearch box

  var filterit = function () {
    let url = new URL(window.location);
    let params = url.searchParams;
    const quicksearch = document.getElementById('quicksearch');
    if (quicksearch) quicksearch.value = '';

    var filterValue = this.getAttribute('data-filter');
    var filterClass = filterValue.replace(/ /g, "-"); // Replaces all spaces

    if (quicksearch) quicksearch.value += filterValue;

    const goButton = document.getElementById('goButton');
    if (goButton) goButton.click();

    params.set('filter', filterValue);
    var p = params.toString();
    window.history.replaceState({}, '', location.pathname + '?' + p);

    var filterValueclass = "." + filterClass;
    document.querySelectorAll(filterValueclass).forEach(el => el.classList.add('active'));
  };

  // run filterit function when link/button with class filter clicked
  document.querySelectorAll('a.filter').forEach(el => el.addEventListener('click', filterit));
  */

  // click goButton to search if return pressed in search box
  const quicksearchKeypress = document.getElementById('quicksearch');
  if (quicksearchKeypress) {
    quicksearchKeypress.addEventListener('keypress', function (e) {
      if (e.key === 'Enter' || e.which === 13) { //Enter key pressed
        const goButton = document.getElementById('goButton');
        if (goButton) {
          goButton.click(); //Trigger search button click event
        }
      }
    });
  }


  document.addEventListener('DOMContentLoaded', function () {
    let url = new URL(window.location);
    let params = url.searchParams;
    var dataFilter = params.get('q');
    var sceneFilter = params.get('scene');
    var playerFilter = params.get('player');
    var hashfilter = decodeURIComponent(location.hash.substring(1));

    const quicksearchInput = document.getElementById('quicksearch');
    const goButton = document.getElementById('goButton');
    const filtersButton = document.getElementById('filters');
    const playersSelect = document.getElementById('players');
    const scenesSelect = document.getElementById('scenes');
    const sideSceneScroll = document.getElementById('side-scene-scroll');


    if (dataFilter && quicksearchInput && goButton) {
      quicksearchInput.value = dataFilter;
      goButton.click();
      params.delete('scene');
      params.delete('player');
      if (filtersButton) filtersButton.click();
    }
    else if (playerFilter && playersSelect) {
      params.delete('q');
      playersSelect.value = playerFilter;
      // Dispatch change event
      const changeEvent = new Event('change', { bubbles: true });
      playersSelect.dispatchEvent(changeEvent);
      if (filtersButton) filtersButton.click();
    }
    else if (sceneFilter && scenesSelect) {
      params.delete('q');
      scenesSelect.value = sceneFilter;
      // Dispatch change event
      const changeEvent = new Event('change', { bubbles: true });
      scenesSelect.dispatchEvent(changeEvent);
      if (sideSceneScroll) sideSceneScroll.classList.add('d-none');
    }
    else if (hashfilter) {
      params.delete('q');
      params.delete('scene');
      params.delete('player');
      const hashedElement = document.getElementById(hashfilter);
      if (hashedElement) {
        hashedElement.classList.add('anchored-highlight');
      }
    }
    else {
      // No specific filter in URL
    }
    // Update URL if params were modified (e.g., by deletion)
    var p = params.toString();
    if (p !== url.searchParams.toString()){ // only replace if changed
        window.history.replaceState({}, '', location.pathname + (p ? '?' + p : ''));
    }
  });
</script>